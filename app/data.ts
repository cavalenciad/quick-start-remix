////////////////////////////////////////////////////////////////////////////////
// üõë Nothing in here has anything to do with Remix, it's just a fake database
////////////////////////////////////////////////////////////////////////////////

import { matchSorter } from "match-sorter";
// @ts-expect-error - no types, but it's a tiny function
import sortBy from "sort-by";
import invariant from "tiny-invariant";

type ContactMutation = {
  id?: string;
  name?: string;
  scientific_name?: string;
  avatar?: string;
  description?: string;
  notes?: string;
  favorite?: boolean;
};

export type ContactRecord = ContactMutation & {
  id: string;
  createdAt: string;
};

////////////////////////////////////////////////////////////////////////////////
// This is just a fake DB table. In a real app you'd be talking to a real db or
// fetching from an existing API.
const fakeContacts = {
  records: {} as Record<string, ContactRecord>,

  async getAll(): Promise<ContactRecord[]> {
    return Object.keys(fakeContacts.records)
      .map((key) => fakeContacts.records[key])
      .sort(sortBy("-createdAt", "scientific_name"));
  },

  async get(id: string): Promise<ContactRecord | null> {
    return fakeContacts.records[id] || null;
  },

  async create(values: ContactMutation): Promise<ContactRecord> {
    const id = values.id || Math.random().toString(36).substring(2, 9);
    const createdAt = new Date().toISOString();
    const newContact = { id, createdAt, ...values };
    fakeContacts.records[id] = newContact;
    return newContact;
  },

  async set(id: string, values: ContactMutation): Promise<ContactRecord> {
    const contact = await fakeContacts.get(id);
    invariant(contact, `No contact found for ${id}`);
    const updatedContact = { ...contact, ...values };
    fakeContacts.records[id] = updatedContact;
    return updatedContact;
  },

  destroy(id: string): null {
    delete fakeContacts.records[id];
    return null;
  },
};

////////////////////////////////////////////////////////////////////////////////
// Handful of helper functions to be called from route loaders and actions
export async function getContacts(query?: string | null) {
  await new Promise((resolve) => setTimeout(resolve, 500));
  let contacts = await fakeContacts.getAll();
  if (query) {
    contacts = matchSorter(contacts, query, {
      keys: ["name", "scientific_name"],
    });
  }
  return contacts.sort(sortBy("name", "createdAt"));
}

export async function createEmptyContact() {
  const contact = await fakeContacts.create({});
  return contact;
}

export async function getContact(id: string) {
  return fakeContacts.get(id);
}

export async function updateContact(id: string, updates: ContactMutation) {
  const contact = await fakeContacts.get(id);
  if (!contact) {
    throw new Error(`No contact found for ${id}`);
  }
  await fakeContacts.set(id, { ...contact, ...updates });
  return contact;
}

export async function deleteContact(id: string) {
  fakeContacts.destroy(id);
}

[
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/loro_orejiamarillo_ognorhynchus_icterotis_26740_0_600.webp",
    name: "Orop√©ndola",
    adjective: "Chocoana",
    scientific_name: "Psarocolius cassini",
    description: "Tambi√©n se le conoce como la orop√©ndola Baud√≥ (Psarocolius cassini), es una hermosa y llamativa ave end√©mica de Colombia. Habita espec√≠ficamente en el Choco, al noreste de la regi√≥n, viviendo en estribaciones y tierras bajas. Su poblaci√≥n est√° en descenso a causa de la destrucci√≥n de los bosques, por lo que se ha clasificado como Vulnerable. Mide entre 40 a 46 cm, siendo los machos m√°s grandes. Es principalmente de color negro, pero el plumaje superior es casta√±o, con zonas desnudas en la cara de color rojizo al igual que sobre las alas, y la cola amarilla.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/oropendola_chocoana_psarocolius_cassini_26740_1_600.webp",
    name: "Carpinterito",
    adjective: "Colombiano",
    scientific_name: "Picumnus granadensis",
    description: "El carpintero o carpinterito colombiano (Picumnus granadensis), es un tipo de carpintero y tambi√©n un ave nativa de Colombia, de hecho, es end√©mica. Se clasifica como de Menor preocupaci√≥n, aunque su poblaci√≥n est√° en descenso. El plumaje superior es marr√≥n gris√°ceo, mientras que abajo es m√°s claro. Adem√°s estas aves de Colombia poseen una corona m√°s oscura con manchas blancas que les dan un aspecto muy curioso. Se desarrolla en diversos bosques en el oeste de Colombia.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/carpinterito_colombiano_picumnus_granadensis_26740_2_600.webp",
    name: "Cucarachero",
    adjective: "Samario",
    scientific_name: "Troglodytes monticola",
    description: "El cucarachero o reyezuelo de Santa Marta (Troglodytes monticola) es otra de las especies de aves end√©mica de Colombia, espec√≠ficamente de la Sierra Nevada de Santa Marta, donde habita en los limites de bosques en arbustos peque√±os y que corresponden con el ecotono a grandes alturas. Lamentablemente, debido a la severa deforestaci√≥n que solo deja menos del 15% del bosque original, esta ave de Colombia est√° clasificada En peligro Cr√≠tico de extinci√≥n. Su tama√±o es de unos 11,5 cm, el color superior es marr√≥n rojizo, con franjas negruzcas en la parte inferior de la espalda, mientras que las plumas de la cola son de color marr√≥n"
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/cucarachero_de_santa_marta_troglodytes_monticola_26740_3_600.webp",
    name: "Pav√≥n",
    adjective: "Pico Azul",
    scientific_name: "Crax alberti",
    description: "El pav√≥n piquiazul (Crax alberti), es un ave nativa y end√©mica de Colombia. Es un ave hermosa y enorme, de casi un metro de largo y una masa entre 3,2 a 3,6 kg. Los machos son de color negro con las puntas de las plumas en el vientre blanco, una cresta despeinada y bultos azules en la mand√≠bula inferior del pico, mientras que las hembras poseen el vientre casta√±o, con blanco tanto en su manto como en la cresta, y en el caso de la base del pico el azul es m√°s suave. Estas aves de Colombia viven en bosques h√∫medos a unos 1.200 metros de altura, pero est√°n clasificadas En peligro cr√≠tico de extinci√≥n por la severa degradaci√≥n del h√°bitat.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/3/1/0/_25013_3_600.webp",
    name: "Mac√°",
    adjective: "Tobiano",
    scientific_name: "Podiceps gallardoi",
    description: "Esta especie pertenecen al orden Podicipediformes y es end√©mica de la regi√≥n patag√≥nica de Argentina y Chile. Se trata de un ave con el cuerpo bastante compacto y de unos 28 cm de largo, siendo una especie de zampull√≠n bastante peque√±a. Adem√°s posee requerimientos muy espec√≠ficos a la hora de nidificar, ya que solo lo hace en lagunas de mesetas de aguas cristalinas y transparentes y con presencia de plantas acu√°ticas en la regi√≥n de la Patagonia, y es un rasgo que lo vuelve muy sensible a los cambios de su h√°bitat. Por ello, el mac√° tobiano actualmente se categoriza en peligro cr√≠tico de extinci√≥n."
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/pavon_de_pico_azul_crax_alberti_26740_4_600.webp",
    name: "Monta√±erito",
    adjective: "Paisa",
    scientific_name: "Atlapetes blancae",
    description: "Tambi√©n conocido como pinz√≥n de Antioquia (Atlapetes blancae), es una de las aves end√©micas de Colombia que habita en matorrales con √°rboles bajos o jardines rurales. Tambi√©n es otra ave de Colombia en Peligro de Extinci√≥n por la conversi√≥n del h√°bitat como tierras agr√≠colas. Es una especie de ave colombiana poco conocida, reportada a partir de pocos ejemplares tenidos en museos en los a√±os 70, y que recientemente ha sido identificada en los andes de Colombia. Aun as√≠, hay que esperar estudios m√°s detallados. Tiene una coloraci√≥n marr√≥n gris√°cea en la parte superior, p√°lido en la inferior y la cabeza color naranja opaco.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/montanerito_paisa_atlapetes_blancae_26740_5_600.webp",
    name: "Tangara",
    adjective: "Multicolor",
    scientific_name: "Chlorochrysa nitidissima",
    description: "Otra de las aves de Colombia es la tangara multicolor (Chlorochrysa nitidissima), end√©mica de los Andes occidentales y norcentrales de esta regi√≥n. Se desarrolla en bosques montanos h√∫medos, espacios cubiertos con musgos y algunos bosques secundarios. Tiene un llamativo patr√≥n colorido, que combina el pecho azul el√©ctrico, vientre negro, nuca y las alas verdes, espalda crema, garganta dorada y manchas casta√±o o negro en los o√≠dos. Se le clasifica como Casi amenazado por la p√©rdida y fragmentaci√≥n de los bosques.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/tangara_multicolor_chlorochrysa_nitidissima_26740_6_600.webp",
    name: "Inca",
    adjective: "Antioque√±a",
    scientific_name: "Coeligena orina",
    description: "A esta ave de Colombia tambi√©n se le conoce como frente estelar brillante (Coeligena orina). Es un tipo de colibr√≠ end√©mico, y como muchas otras aves de la regi√≥n colombiana con un colorido llamativo. Mide unos 14 cm y de entre 6 a 7 gr, con el vientre y la rabadilla verde iridiscente. De estas aves colombianas, el macho posee la frente verde y alrededor del cuello zafiro, las hembras no tienen estos √∫ltimos colores pero su garganta es amarillo-naranja. Vive en bosques enanos, h√∫medos y p√°ramos. Se clasifica En peligro de extinci√≥n por la deforestaci√≥n, pero adem√°s el √°rea es de inter√©s minero lo que amenaza a la especie si se empieza esta explotaci√≥n.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/inca_de_antioquia_coeligena_orina_26740_7_600.webp",
    name: "Chachalaca",
    adjective: "Colombiana",
    scientific_name: "Ortalis columbiana",
    description: "La chachalaca o guacharaca colombiana (Ortalis columbiana) es end√©mica del pa√≠s, pero ha sido extirpada de gran parte de su √°rea nativa que eran los Valles del Cauca y Magdalena. Esta ave colombiana tiene una forma similar a una gallina, con un color marr√≥n de diferentes tonos, en el pecho hay l√≠neas blancas que forman un patr√≥n sim√©trico, la garganta y las plumas externas de la cola son rojas. Habita en zonas boscosas, y aunque sus poblaci√≥n se considera en disminuci√≥n, est√° clasificada como de Menor preocupaci√≥n.",
  },
  {
    avatar:
      "https://cdn0.expertoanimal.com/es/posts/0/4/7/chachalaca_colombiana_ortalis_columbiana_26740_8_600.webp",
    name: "Capito",
    adjective: "Dorsiblanco",
    scientific_name: "Capito hypoleucus",
    description: "A esta especie de ave colombiana tambi√©n se le llama cabez√≥n dorsiblanco (Capito hypoleucus), siendo otra de las especies end√©micas de Colombia. Est√° restringido al norte de los Andes centrales y al oeste de los orientales, en bosques h√∫medos y de galer√≠a entre 350 y 2.000 metros. El plumaje de arriba es negro brillante, mientras que el de abajo es un blanco hueso, comuna franja marr√≥n claro a nivel del pecho; y un parche rojo en la frente. A esta ave de Colombia se le clasifica como Vulnerable porque los bosques son impactos y transformados para ganader√≠a y agricultura.",
  },
].forEach((contact) => {
  fakeContacts.create({
    ...contact,
    id: `${contact.name.toLowerCase()}-${contact.adjective.toLowerCase()}`,
  });
});
